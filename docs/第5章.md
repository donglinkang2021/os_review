---
layout: default
title: 文件系统
nav_order: 第5章
---

# 第5章 文件系统

## 易错点整理

- Unix将文件分为三类
  - 普通文件
  - 目录文件
  - 特别文件
- 常用的外存分配方法有三种
  - 连续分配
  - 链接分配
  - 索引分配

## 复习提纲

1. 什么是文件和文件系统? 文件系统的主要功能。UNIX系统如何对文件进行分类？它有什么好处？

    ```markdown
    1. 文件：
        - 文件是存储在外部存储器上的具有符号名的相关信息的集合；
    2. 文件系统：
        - OS中管理文件的软件机构。包括管理文件所需的数据结构、相应的管理软件和被管理的文件。
        - 是OS的信息管理部分，提供文件的按名存取。负责文件的存储、检索和存取保护。
    3. 文件系统的主要功能：
        1. 管理**文件存储器**。记录空间使用情况，分配空间，调整或回收空间。
        2. 实现**按名存取**。利用**目录结构**快速定位文件。
        3. 应具有灵活多样的**文件结构**和**存取方法**，便于用户存储和加工处理信息。
        4. 提供一套使用方便、简单的**操作命令**。
        5. 保证文件信息的**安全性**。
        6. 便于文件的**共享**。
    4. UNIX系统对文件的分类：
        1. `普通文件`：通常的文件。
        2. `目录文件`：由文件目录构成的一类用来维护文件系统结构的文件。对其处理同普通文件。
        3. `特别文件`：
            - 输入设备和输出设备 *字符型特别文件*
            - I/O型设备 *字符块特别文件*
            - 管道文件
            - 系统将对特别文件的操作转换为对设备的操作。
    5. UNIX系统对文件的分类的好处：
        - 便于用户使用。
        - 便于系统对不同类型的文件进行不同的管理，以实现文件的保护和共享。
    ```

2. 文件目录的作用是什么?文件目录项通常包含哪些内容? 文件控制块。

    ```markdown
    1. 文件目录的作用：
        - 使用户实现按名存取文件。
        - 提高对目录的检索速度，从而提高文件的存取速度
        - 方便用户共享文件
    2. 文件目录项通常包含的内容：
        - 文件名
        - 文件标识
        - 类型
        - 存储位置
        - 大小
        - 保护方式
        - 创建或修改日期
    3. 文件控制块
        - 包含了文件的说明信息和管理控制信息
        - 就是一个文件目录项
    ```

3. 文件的逻辑结构有几种形式？文件的存取方法？

    ```markdown
    1. 文件的逻辑结构
        1. 无结构文件 *流式文件*
            1. 由无结构的先后到达的相关字节组成，
            2. 其文件长度就是所包含的字节个数
        2. 有结构文件 *记录式文件*
            - 定长记录文件
            - 变长记录文件
    2. 文件的存取方法
        1. 顺序存取
            - 按照文件信息的逻辑顺序一次存取
            - 实在前一次存取的基础上进行的
            - 在存取过程中总有两个位置指针指向其中要读写的位置。适用于顺序访问设备（磁带）和随机访问设备（磁盘）
        2. 随机存取（直接存取）
            - 基于文件的磁盘模型，磁盘允许对任意文件块进行随机读和写
            - 对记录式文件而言，根据记录的编号来直接存取文件中的任意记录
            - 对字节流文件而言，根据系统调用命令把读/写指针调整到欲读/写的位置，然后进行读/写指定字节数的信息
    ```

4. 文件的物理结构有哪几种?对于不同的结构，文件系统是如何进行管理的?

    ```markdown
    1. 文件的物理结构
        1. **连续文件（顺序文件）**
            - 文件内容连续存放
            - 优点
                - 简单
                - 支持顺序存取和随机存取
                - 存取速度快，只要访问一次文件的管理信息，就可以方便地存取到任一记录
            - 缺点
                - 不灵活
                    - 要求在文件创建时，就给出文件的最大长度
                - 容易产生碎片
                    - 由于不断地创建和删除文件，文件存储空间可能出现许多无法利用的空洞
        2. **链接文件**
            - 不要求文件内容连续存放，把文件所占用的物理块用链接指针链接起来。
            - 优点
                - 可以解决外存的碎片问题，提高了外存空间的利用率
                - 可以动态地增加文件的长度
            - 缺点
                - 只能按照文件的指针链顺序存取，不支持随机存取，查找效率低
            - 使用文件分配表FAT可以随机访问
                - 优点
                    - 系统运行时，FAT在主存中，可以顺序访问，也可以随机访问外存的文件
                - 缺点
                    - 运行时整个表必须在主存中，主存消耗大
            - MS-DOS采用FAT
        3. **索引文件**
            - 为每个文件建立一张索引表
            - 用索引表记录文件内容的存放地址，即记录文件的逻辑块号和对应的物理块号之间的关系
            - 当索引表长度超过一个磁盘块时，可以采用多级索引
            - 优点
                - 支持随机、顺序存取
                - 文件可以动态修改
            - 缺点
                - 索引表的使用增加了存储空间的开销
                - 降低了文件的存取速度
            - Unix Linux采用索引文件
        4. **索引顺序文件**
            - Windows的NTFS文件系统
            - MFT（主文件表）：记录文件的属性和位置信息
    2. 文件系统是如何进行管理的
        1. 建议先看一下问题7
        2. 对于不同的结构
            1. 连续文件
                - 采用空白文件目录
            2. 链接文件、索引文件、索引顺序文件
                - 采用空闲块链表法
            3. 索引顺序文件
                - 还可以使用位示图
    ```

    ```markdown
    可以记住一点额外的信息：
    - DOS系统的文件采用**链接结构**。
    - UNIX系统的文件采用**多级索引结构**。
        - 空闲块成组链表
    - Linux的Ext2采用**多级索引结构**
        - 把磁盘块分为组，即块组，每组用位图来管理磁盘块。
    - Windows的NTFS采用**索引顺序结构**
        - 用位图来记录卷上个簇的使用情况
    ```


5. DOS文件卷的结构，DOS系统的文件物理结构是什么？

    ```markdown
    0. 建议看课本p114-p115
    1. DOS文件卷的结构
        1. 磁盘低级格式化
        2. 磁盘分区
        3. 分区格式化
    2. DOS系统的文件物理结构
    ```

6. 了解记录的组块和分解。

    ```markdown
    - 一个物理块可以存放若干个逻辑记录
        - 一个逻辑几里路可以存放在若干个物理块中
        - 把一个块中存放的逻辑记录的个数叫做块因子
    - 必须使用主存缓冲区
        - 信息交换是以块为单位进行的。
        - 用户将要写的记录先写入主存缓冲区
        - 当主存区满时再写磁盘
    - 用户使用记录时
        - 像将包含记录的物理块读入内存缓冲区
        - 然后进行记录分解
    ```

7. 文件存储空间的管理方法有几种?它们各是如何实现文件存储空间的分配和回收的?

    ```markdown
    1. 常用的对磁盘存储空间的管理方法
        - **空白文件目录**
            - 空白文件
                - 一个连续未使用的空闲盘块区
            - 空白文件目录
                - 系统为这些空白文件建立一张表
                - 每个空白文件占用一个表目
            - 适合文件的静态分配
        - **空闲块链表**
            - 把所有的空闲块连接成一个链表
            - 优点
                - 简单适合文件动态分配
            - 缺点
                - 工作效率低
                - 分配和回收多个盘块都需要多次访问磁盘才能完成
            - 空闲块成组链表
                - 利用盘空闲块来管理盘上的空闲块，每个磁盘块记录尽可能多的空闲块而成一组。
                - 各组之间也用链指针链接在一起
                - 便于空闲块的分配和回收
                - 适合连续文件、链接文件、和索引文件的存储分配
        - **位示图**
            - 位映像表bitmap
            - 每一个二进制位对应一个物理盘块
            - 为1时表示块已经分配，为0时表示空闲
            - 优点
                - 容易找到一个或几个连续的空闲块。其尺寸固定，可以保存在主存，便于分配和回收空间
    ```


8. 建立多级目录有哪些好处?文件的重名和共享问题是如何得到解决的?

    ```markdown
    1. 建立多级目录的好处
        - 层次清晰，便于管理和维护
        - 有利于文件分类
        - 解决重名问题
        - 提高文件检索的速度
        - 能够控制存取权限
    2. 文件的重名和共享问题
        - 重名问题依靠多级目录解决了
            - 只要绝对路径名不一样即可
        - 共享问题的解决
            - 硬链接
                - 在共享目录项中简单地重复被共享文件的信息
                - 因此两个目录项的索引节点相同
            - 软连接（符号链接）
                - 创建一个新的目录项，其中存有指向另一个文件或目录的绝对路径名
    ```

9. 文件系统中，常用的文件操作命令有哪些？它们的具体功能是什么?打开和关闭文件命令的目的是什么?

    ```markdown
    1. 文件操作命令及其具体功能
        1. 创建文件
            - 主要功能：在指定设备上为指定路径名的文件建立一个目录项，并设置文件的有关属性。
        2. 删除文件
            - 主要功能：根据文件的路径名找到指定的目录项，回收其占用的各个物理块，再将该目录项置为空。
        3. 打开文件
            - 根据文件路径名找到文件目录项，进而找到FCB，将FCB复制到内存并记录到系统打开文件表。
            - 系统打开文件表是由文件对象组成的链表。
            - 文件对象记录了文件读/写位置指针、文件方法、共享该文件的进程数等信息。
            - Linux，文件对象地址记录在进程打开文件表里；Windows文件对象地址记录在进程句柄表里。返回表的索引。
        4. 关闭文件
            - 释放文件在主存专门区域中的目录项，切断用户与文件的联系。
            - 若该目录项被修改过，则复制到磁盘。
            - 若文件作过某些修改，应将其写回辅存。
        5. 读文件
            - 命令中必须指出要读的数据个数，以及存放数据的主存地址。
            - 根据文件所在设备、文件类型的不同，系统设置不同的读命令。
        6. 修改文件
            - 命令中必须指出要写的数据个数，以及存放数据的主存地址，将主存中的数据写到指定的文件中。
        7. 追加文件
            - 限制了写文件的形式，将数据追加到文件尾。
        8. 随机存取文件
            - 重新定位文件的读/写位置指针。
        9. 得到文件属性
            - 进程在执行时常常需要了解文件的属性。在UNIX系统中，一个软件开发项目通常由多个源文件组成，make程序用来管理这些源文件。当make被调用时，它检查所有源文件和目标文件的修改时间，并且编排出需要重新编译的文件数。
        10. 设置文件属性
            - 修改文件的一些属性，以适应用户的要求。
        11.  重命名文件
            - 重新命名一个已经存在的文件。
    2. 打开和关闭文件命令的目的
        - 打开文件
            - 根据文件路径名找到文件目录项，进而找到FCB，将FCB复制到内存并记录到系统打开文件表。
            - 避免多次重复地检索文件目录
        - 关闭文件
            - 释放文件在主存专门区域中的目录项
            - 切断用户与文件的联系
    ```

10. 存取控制表ACL的概念。

    ```markdown
    - 为存取控制居中中的每一列建立一张存取控制表ACL
        - 用一有序对（域，权集）表示
    - 文件的ACL记录在FCB中
    - 例如 `File1(D1,rwx)`表示 `File1` 在域 `D1` 中，可读可写可执行；
    ```

11. 理解内存映射文件（memory mapped file）的过程。

    ```markdown
    - 将文件映射到进程地址空间的一个区域，返回虚拟地址，仅当对文件存取时，才传输实际的数据
    - 采用与请求页式虚存管理相同的存取机制
        - 访问的页不在主存时，产生缺页中断读入主存
    - 操作系统提供映射文件的系统调用
    ```